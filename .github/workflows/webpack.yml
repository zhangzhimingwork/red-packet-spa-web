name: CI with Husky, Jest, and Cypress

on:
  push:
    branches:
      - '**'

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出代码
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. 设置 Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 3. 安装依赖
      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      # 4. 初始化 Husky
      - name: Initialize Husky
        run: npm run prepare

      # 5. 并行执行单元测试和 E2E 测试
      - name: Run Tests
        run: |
          # 启动前端服务后台运行
          yarn dev &
          # 等待服务启动
          npx wait-on http://localhost:3000
          # 执行 Husky pre-push 钩子（单元+E2E测试）
          .husky/pre-push

      # 6. 构建项目（只有测试全部通过才执行）
      - name: Build Project
        run: npm run build
